# monitoring/helmrelease-kube-prometheus-stack.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kps
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "67.*"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: monitoring
  values:
    grafana:
      adminPassword: "changeme"   # set via Secret if you prefer
      service:
        type: ClusterIP
      defaultDashboardsTimezone: Europe/London

    prometheus:
      prometheusSpec:
        retention: 15d
        retentionSize: 10GB
        scrapeInterval: 30s
        evaluationInterval: 30s
        resources:
          requests: { cpu: 100m, memory: 512Mi }
          limits:   { cpu: 1,    memory: 2Gi }

    # Enable blackbox-exporter for external probes (DNS/HTTP/TCP)
    blackboxExporter:
      enabled: true
      serviceMonitor:
        enabled: true
      config:
        modules:
          http_2xx:
            prober: http
          tcp_connect:
            prober: tcp
          dns_udp:
            prober: dns
            dns:
              query_name: example.com
              preferred_ip_protocol: ip4
              transport_protocol: udp

    # Alertmanager basic config (routes to Slack via secret file)
    # alertmanager:
    #   alertmanagerSpec:
    #     secrets:
    #       - alertmanager-slack-webhook
    #   config:
    #     route:
    #       receiver: default
    #       group_wait: 30s
    #       group_interval: 5m
    #       repeat_interval: 4h
    #     receivers:
    #       - name: default
    #         slack_configs:
    #           - channel: "#homelab"
    #             send_resolved: true
    #             api_url_file: /etc/alertmanager/secrets/alertmanager-slack-webhook/slack_webhook
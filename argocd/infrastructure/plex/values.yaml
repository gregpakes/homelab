controllers:
  plex:
    replicas: 1
    initContainers:

        - name: fetch-vaapi
          # Ubuntu userspace to fetch .debs (no effect on main image)
          image: ubuntu:24.04
          securityContext:
            allowPrivilegeEscalation: false
          command:
            - bash
            - -lc
            - |
              set -euo pipefail
              apt-get update
              # download but don't install
              apt-get download \
                intel-media-va-driver-non-free \
                libigdgmm12 \
                libva2 libva-drm2
              mkdir -p /vaapi/lib /vaapi/dri
              # extract all .debs into /tmp/extract then copy needed bits
              mkdir -p /tmp/extract
              for f in ./*.deb; do dpkg -x "$f" /tmp/extract; done
              # copy driver + libs to our bundle
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/dri/* /vaapi/dri/ || true
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/libva* /vaapi/lib/ || true
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/libigdgmm*.so* /vaapi/lib/ || true
              # sanity
              ls -l /vaapi/dri | grep iHD || { echo "iHD driver missing"; exit 1; }
              ldconfig -v -n /vaapi/lib || true
          volumeMounts:
            - name: vaapi-bundle
              mountPath: /vaapi

    containers:
      app:
        image:
          repository: lscr.io/linuxserver/plex
          tag: latest
        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "Europe/London"
          # ðŸ‘‡ Tell Plex what to advertise to clients/plex.tv
          ADVERTISE_IP: "http://172.16.51.70:32400/,https://plex.gregpakes.co.uk"

          # ðŸ‘‡ Make both your LAN and the K3s pod CIDR count as local
          ALLOWED_NETWORKS: "172.16.0.0/16,10.42.0.0/16"

          # ðŸ‘‡ Ensure the fast scratch path is used
          PLEX_TRANSCODE_TMPDIR: "/transcode"

          LIBVA_DRIVER_NAME: "iHD"
          LIBVA_DRIVERS_PATH: "/usr/lib/x86_64-linux-gnu/dri"
          VAAPI_DEVICE: "/dev/dri/renderD128"

        envFrom:
          - secretRef:
              name: plex-env
        resources:
          requests:
            cpu: 1000m
          limits:
            cpu: 2000m
            memory: 4Gi
        securityContext:
          allowPrivilegeEscalation: false

    pod:
      securityContext:
        fsGroup: 1000
        # Match these to your host GIDs for video/render
        supplementalGroups: [44, 992]
  volumes:
      - name: vaapi-bundle
        emptyDir: {}

service:
  app:
    controller: plex
    type: LoadBalancer
    externalTrafficPolicy: Local
    loadBalancerIP: 172.16.51.70  # <-- your reserved IP for Plex
    ports:
      http:
        port: 32400          # TCP 32400 (main)
      gdm1:
        port: 32410
        protocol: UDP        # GDM discovery
      gdm2:
        port: 32412
        protocol: UDP
      gdm3:
        port: 32413
        protocol: UDP
      gdm4:
        port: 32414
        protocol: UDP
      upnp-dlna:
        port: 1900
        protocol: UDP        # DLNA SSDP (optional)
      companion:
        port: 8324 

metrics:
  serviceMonitor:
    enabled: true
    # if you use kube-prometheus-stack, add its selector
    additionalLabels:
      release: kube-prometheus-stack

ingress:
  app:
    enabled: true
    className: traefik
    hosts:
      - host: plex.gregpakes.co.uk
        paths:
          - path: /
            service:
              identifier: app
              port: http

persistence:
  # 1ï¸âƒ£ CONFIG on Longhorn (RWO)
  config:
    enabled: true
    storageClass: longhorn
    size: 50Gi
    accessMode: ReadWriteOnce
    retain: true
    globalMounts:
      - path: /config

  # 2ï¸âƒ£ MEDIA via direct NFS mount (your NAS library)
  media:
    enabled: true
    type: nfs
    server: 172.16.250.191           # <-- your UniFi UNAS IP
    path: /var/nfs/shared/Media      # <-- existing export path
    # readOnly: true                  # enable if you want Plex read-only
    globalMounts:
      - path: /data

  # 3ï¸âƒ£ TRANSCODE scratch in memory (fast)
  transcode:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 8Gi
    globalMounts:
      - path: /transcode

  # 4ï¸âƒ£ Intel Arc A310 (VAAPI)
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    globalMounts:
      - path: /dev/dri
controllers:
  plex:
    replicas: 1

    initContainers:
      fetch-vaapi:
        image:
          repository: alpine
          tag: "3.20"
          pullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
        command:
          - sh
          - -lc
          - |
            set -euo pipefail
            # Use edge for intel-media-driver if not in your base repo
            echo "https://dl-cdn.alpinelinux.org/alpine/edge/main"      >> /etc/apk/repositories
            echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
            apk add --no-cache libva libva-utils intel-media-driver

            # Stage ONLY the VAAPI bits into the shared bundle
            mkdir -p /opt/vaapi/dri /opt/vaapi/lib
            cp -a /usr/lib/dri/iHD_drv_video.so /opt/vaapi/dri/
            cp -a /usr/lib/libva.so.* /opt/vaapi/lib/ || true
            cp -a /usr/lib/libva-drm.so.* /opt/vaapi/lib/ || true

            echo "== staged files =="
            ls -l /opt/vaapi/dri /opt/vaapi/lib
  
    containers:
      app:
        image:
          repository: lscr.io/linuxserver/plex
          tag: latest
        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "Europe/London"
          # ðŸ‘‡ Tell Plex what to advertise to clients/plex.tv
          ADVERTISE_IP: "http://172.16.51.70:32400/,https://plex.gregpakes.co.uk"

          # ðŸ‘‡ Make both your LAN and the K3s pod CIDR count as local
          ALLOWED_NETWORKS: "172.16.0.0/16,10.42.0.0/16"

          # ðŸ‘‡ Ensure the fast scratch path is used
          PLEX_TRANSCODE_TMPDIR: "/transcode"

          LIBVA_DRIVER_NAME: "iHD"
          LIBVA_DRIVERS_PATH: "/opt/vaapi/dri"
          VAAPI_DEVICE: "/dev/dri/renderD128"
          LD_LIBRARY_PATH: "/opt/vaapi/lib"

        envFrom:
          - secretRef:
              name: plex-env
        resources:
          requests:
            cpu: 1000m
          limits:
            cpu: 2000m
            memory: 4Gi
        securityContext:
          allowPrivilegeEscalation: false

    pod:
      securityContext:
        fsGroup: 1000
        # Match these to your host GIDs for video/render
        supplementalGroups: [44, 992]

service:
  app:
    controller: plex
    type: LoadBalancer
    externalTrafficPolicy: Local
    loadBalancerIP: 172.16.51.70  # <-- your reserved IP for Plex
    ports:
      http:
        port: 32400          # TCP 32400 (main)
      gdm1:
        port: 32410
        protocol: UDP        # GDM discovery
      gdm2:
        port: 32412
        protocol: UDP
      gdm3:
        port: 32413
        protocol: UDP
      gdm4:
        port: 32414
        protocol: UDP
      upnp-dlna:
        port: 1900
        protocol: UDP        # DLNA SSDP (optional)
      companion:
        port: 8324 

metrics:
  serviceMonitor:
    enabled: true
    # if you use kube-prometheus-stack, add its selector
    additionalLabels:
      release: kube-prometheus-stack

ingress:
  app:
    enabled: true
    className: traefik
    hosts:
      - host: plex.gregpakes.co.uk
        paths:
          - path: /
            service:
              identifier: app
              port: http

persistence:
  # 1ï¸âƒ£ CONFIG on Longhorn (RWO)
  config:
    enabled: true
    storageClass: longhorn
    size: 50Gi
    accessMode: ReadWriteOnce
    retain: true
    globalMounts:
      - path: /config

  # 2ï¸âƒ£ MEDIA via direct NFS mount (your NAS library)
  media:
    enabled: true
    type: nfs
    server: 172.16.250.191           # <-- your UniFi UNAS IP
    path: /var/nfs/shared/Media      # <-- existing export path
    # readOnly: true                  # enable if you want Plex read-only
    globalMounts:
      - path: /data

  # 3ï¸âƒ£ TRANSCODE scratch in memory (fast)
  transcode:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 8Gi
    globalMounts:
      - path: /transcode

  # 4ï¸âƒ£ Intel Arc A310 (VAAPI)
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    globalMounts:
      - path: /dev/dri

  # âœ… EmptyDir that both initContainer and app use at /opt/vaapi
  vaapi-bundle:
    enabled: true
    type: emptyDir
    globalMounts:
      - path: /opt/vaapi
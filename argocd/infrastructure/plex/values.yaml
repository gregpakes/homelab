controllers:
  plex:
    replicas: 1
    
    containers:
      app:
        image:
          repository: lscr.io/linuxserver/plex
          tag: latest
        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "Europe/London"
          # 👇 Tell Plex what to advertise to clients/plex.tv
          ADVERTISE_IP: "http://172.16.51.70:32400/,https://plex.gregpakes.co.uk"

          # 👇 Make both your LAN and the K3s pod CIDR count as local
          ALLOWED_NETWORKS: "172.16.0.0/16,10.42.0.0/16"

          # 👇 Ensure the fast scratch path is used
          PLEX_TRANSCODE_TMPDIR: "/transcode"

          LIBVA_DRIVER_NAME: "iHD"
          LIBVA_DRIVERS_PATH: "/opt/vaapi/dri"
          VAAPI_DEVICE: "/dev/dri/renderD128"
          LD_LIBRARY_PATH: "/opt/vaapi/lib:/usr/lib/x86_64-linux-gnu:/usr/lib:/lib"

        envFrom:
          - secretRef:
              name: plex-env
        resources:
          requests:
            cpu: 1000m
          limits:
            cpu: 2000m
            memory: 4Gi
        securityContext:
          allowPrivilegeEscalation: false
        volumeMounts:
          - name: vaapi-bundle         # 👈 mount the bundle into the app
            mountPath: /opt/vaapi

    volumes:
      vaapi-bundle:                   # 👈 volumes is a MAP keyed by name
        type: emptyDir

    pod:
      securityContext:
        fsGroup: 1000
        # Match these to your host GIDs for video/render
        supplementalGroups: [44, 992]

      initContainers:
        fetch-vaapi:
          image: ubuntu:24.04
          securityContext:
            allowPrivilegeEscalation: false
          command:
            - bash
            - -lc
            - |
              set -euo pipefail
              apt-get update
              apt-get download intel-media-va-driver-non-free libigdgmm12 libva2 libva-drm2
              mkdir -p /vaapi/lib /vaapi/dri /tmp/extract
              for f in ./*.deb; do dpkg -x "$f" /tmp/extract; done
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/dri/* /vaapi/dri/ || true
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/libva* /vaapi/lib/ || true
              cp -a /tmp/extract/usr/lib/x86_64-linux-gnu/libigdgmm*.so* /vaapi/lib/ || true
              ls -l /vaapi/dri | grep iHD
          volumeMounts:
            - name: vaapi-bundle
              mountPath: /vaapi

service:
  app:
    controller: plex
    type: LoadBalancer
    externalTrafficPolicy: Local
    loadBalancerIP: 172.16.51.70  # <-- your reserved IP for Plex
    ports:
      http:
        port: 32400          # TCP 32400 (main)
      gdm1:
        port: 32410
        protocol: UDP        # GDM discovery
      gdm2:
        port: 32412
        protocol: UDP
      gdm3:
        port: 32413
        protocol: UDP
      gdm4:
        port: 32414
        protocol: UDP
      upnp-dlna:
        port: 1900
        protocol: UDP        # DLNA SSDP (optional)
      companion:
        port: 8324 

metrics:
  serviceMonitor:
    enabled: true
    # if you use kube-prometheus-stack, add its selector
    additionalLabels:
      release: kube-prometheus-stack

ingress:
  app:
    enabled: true
    className: traefik
    hosts:
      - host: plex.gregpakes.co.uk
        paths:
          - path: /
            service:
              identifier: app
              port: http

persistence:
  # 1️⃣ CONFIG on Longhorn (RWO)
  config:
    enabled: true
    storageClass: longhorn
    size: 50Gi
    accessMode: ReadWriteOnce
    retain: true
    globalMounts:
      - path: /config

  # 2️⃣ MEDIA via direct NFS mount (your NAS library)
  media:
    enabled: true
    type: nfs
    server: 172.16.250.191           # <-- your UniFi UNAS IP
    path: /var/nfs/shared/Media      # <-- existing export path
    # readOnly: true                  # enable if you want Plex read-only
    globalMounts:
      - path: /data

  # 3️⃣ TRANSCODE scratch in memory (fast)
  transcode:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 8Gi
    globalMounts:
      - path: /transcode

  # 4️⃣ Intel Arc A310 (VAAPI)
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    globalMounts:
      - path: /dev/dri
controllers:
  plex:
    replicas: 1
  
    containers:
      app:
        image:
          repository: lscr.io/linuxserver/plex
          tag: latest
        env:
          PUID: "1000"
          PGID: "988"
          TZ: "Europe/London"
          # ðŸ‘‡ Tell Plex what to advertise to clients/plex.tv
          ADVERTISE_IP: "http://172.16.51.70:32400,https://plex.gregpakes.co.uk:443"

          # ðŸ‘‡ Make both your LAN and the K3s pod CIDR count as local
          ALLOWED_NETWORKS: "172.16.0.0/16,10.42.0.0/16"

          # ðŸ‘‡ Ensure the fast scratch path is used
          PLEX_TRANSCODE_TMPDIR: "/transcode"

          DOCKER_MODS: "linuxserver/mods:universal-package-install"
          INSTALL_PACKAGES: "intel-media-va-driver-non-free libigdgmm12 libva2 libva-drm2 libdrm2 vainfo"

          # Optional: hint libva (not strictly required on Ubuntu)
          LIBVA_DRIVER_NAME: "iHD"
          VAAPI_DEVICE: "/dev/dri/renderD128" 

        envFrom:
          - secretRef:
              name: plex-env
        resources:
          requests:
            cpu: 1000m
            memory: 4Gi
        securityContext:
          allowPrivilegeEscalation: false
          privileged: true

    pod:
      securityContext:
        fsGroup: 988
        # Match these to your host GIDs for video/render
        supplementalGroups: [44, 109, 992]
      labels:
        app: plex
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: tdarr-node
              namespaces:
                - servarr
              topologyKey: kubernetes.io/hostname

service:
  app:
    controller: plex
    type: LoadBalancer
    externalTrafficPolicy: Local
    loadBalancerIP: 172.16.51.70  # <-- your reserved IP for Plex
    ports:
      http:
        port: 32400          # TCP 32400 (main)
      gdm1:
        port: 32410
        protocol: UDP        # GDM discovery
      gdm2:
        port: 32412
        protocol: UDP
      gdm3:
        port: 32413
        protocol: UDP
      gdm4:
        port: 32414
        protocol: UDP
      upnp-dlna:
        port: 1900
        protocol: UDP        # DLNA SSDP (optional)
      companion:
        port: 8324 

metrics:
  serviceMonitor:
    enabled: true
    # if you use kube-prometheus-stack, add its selector
    additionalLabels:
      release: kube-prometheus-stack

ingress:
  app:
    annotations:
      traefik.ingress.kubernetes.io/router.middlewares: "plex-plex-headers@kubernetescrd"
    enabled: true
    className: traefik-external
    hosts:
      - host: plex.gregpakes.co.uk
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - plex.gregpakes.co.uk

persistence:
  # 1ï¸âƒ£ CONFIG on Longhorn (RWO)
  config:
    enabled: true
    storageClass: longhorn
    size: 50Gi
    accessMode: ReadWriteOnce
    retain: true
    globalMounts:
      - path: /config

  # 2ï¸âƒ£ MEDIA via direct NFS mount (your NAS library)
  media:
    enabled: true
    type: nfs
    server: 172.16.250.191           # <-- your UniFi UNAS IP
    path: /var/nfs/shared/Media      # <-- existing export path
    # readOnly: true                  # enable if you want Plex read-only
    globalMounts:
      - path: /data

  # 3ï¸âƒ£ TRANSCODE scratch in memory (fast)
  transcode:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 8Gi
    globalMounts:
      - path: /transcode

 # removed because we use the intel Intel GPU Device Plugin Helm Chart
  # 4ï¸âƒ£ Intel Arc A310 (VAAPI)
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    globalMounts:
      - path: /dev/dri

# Keep CRDs managed by the chart
crds:
  enabled: true
  keep: true

# Prometheus (Operator) config
prometheus:
  enabled: true
  prometheusSpec:
    retention: 15d
    scrapeInterval: 30s
    enableAdminAPI: true

    # Persist TSDB on Longhorn with Retain
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-rbd 
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 75Gi

    # Scrape ANY ServiceMonitor/PodMonitor in ANY namespace
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
    podMonitorSelector: {}
    podMonitorNamespaceSelector: {}
    ruleSelector: {}
    ruleNamespaceSelector: {}
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false

# Alertmanager (optional persistence)
alertmanager:
  enabled: true
  alertmanagerSpec:
    secrets:
      - alert-manager-pushover
  
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi

  config:
    global:
      resolve_timeout: 5m
    route:
      receiver: pushover
    receivers:
      - name: "null"
      
      - name: pushover
        pushover_configs:
          - user_key_file: /etc/alertmanager/secrets/alert-manager-pushover/user_key
            token_file: /etc/alertmanager/secrets/alert-manager-pushover/token
            title: '{{ .CommonLabels.alertname }}'
            message: '{{ .CommonAnnotations.summary }}'

# Grafana
grafana:
  enabled: true
  adminUser: admin
  adminPassword: "changeme"  # (recommend moving to External Secrets later)
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 10Gi
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: "ALL"   # pick up Rancher/other namespaces too
    datasources:
      enabled: true
      defaultDatasourceEnabled: true
  grafana.ini:
    server:
      # If you publish Grafana under a subpath in Rancher, use e.g. https://rancher.example/grafana and set serve_from_sub_path: true
      root_url: https://grafana.gregpakes.co.uk
      serve_from_sub_path: false
    security:
      cookie_samesite: none
      cookie_secure: true
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - grafana.gregpakes.co.uk
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    # no tls section as traefik will use the default cert

# K3s specifics â€” keep etcd off unless you wire certs/endpoint
kubeEtcd:
  enabled: true
  endpoints:
    - 172.16.51.201
    - 172.16.51.202
    - 172.16.51.203
  service:
    enabled: true
    port: 2381
    targetPort: 2381

kubeControllerManager:
  enabled: false
  endpoints:
    - 172.16.51.201
    - 172.16.51.202
    - 172.16.51.203
kubeScheduler:
  enabled: false # not needed in k3s
kubeApiServer:
  enabled: false
kubeProxy:
  enabled: false
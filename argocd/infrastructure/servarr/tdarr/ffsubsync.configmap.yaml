apiVersion: v1
kind: ConfigMap
metadata:
  name: tdarr-ffsubsync-scripts
data:
  ffsubsync.sh: |
    #!/usr/bin/env bash
    set -euo pipefail

    VIDEO="${1}"
    DIR="$(dirname "$VIDEO")"
    BASE="$(basename "$VIDEO")"
    NAME="${BASE%.*}"

    MARKER="Synced by ffsubsync"

    shopt -s nullglob
    for SRT in "$DIR/$NAME"*.srt; do
      if head -c 4000 "$SRT" | grep -q "$MARKER"; then
        continue
      fi

      TMP="${SRT}.synced"
      /pytools/bin/ffsubsync "$VIDEO" -i "$SRT" -o "$TMP"

      { printf "1\n00:00:00,000 --> 00:00:00,001\n%s\n\n" "$MARKER"; cat "$TMP"; } > "$TMP.marked"
      mv "$TMP.marked" "$SRT"
      rm -f "$TMP"
    done
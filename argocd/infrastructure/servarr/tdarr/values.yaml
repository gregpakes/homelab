controllers:
  server:
    strategy: Recreate
    replicas: 1
    pod:
      securityContext:
        fsGroup: 988
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [44, 992]
      labels:
        app: tdarr-server
    initContainers:
      perms:
        image:
          repository: alpine
          tag: "3.20"
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /temp /app/server /app/configs &&
            chown -R 1000:988 /temp /app/server /app/configs &&
            chmod -R u+rwX,g+rwX /temp /app/server /app/configs
        securityContext:
          runAsUser: 0
          runAsGroup: 0

    containers:
      tdarr:
        image:
          repository: docker.io/haveagitgat/tdarr
          tag: latest
        env:
          TZ: Europe/London
          PUID: "1000"
          PGID: "988"

  node:
    strategy: Recreate
    replicas: 1
    pod:
      securityContext:
        fsGroup: 988
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [44, 992]
      labels:
        app: tdarr-node
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: plex
              namespaces:
                - plex
              topologyKey: kubernetes.io/hostname
    initContainers:
      perms:
        image:
          repository: alpine
          tag: "3.20"
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /temp &&
            chown -R 1000:988 /temp &&
            chmod -R u+rwX,g+rwX /temp
        securityContext:
          runAsUser: 0
          runAsGroup: 0

      ffsubsync:
        image:
          repository: python
          tag: "3.12-slim"
        command: ["/bin/sh", "-c"]
        args:
          - |
            apt-get update && apt-get install -y --no-install-recommends gcc g++ make \
            && rm -rf /var/lib/apt/lists/* \
            && pip install --no-cache-dir --target=/pytools ffsubsync \
            && sed -i '1s|^#!.*$|#!/usr/bin/env python3|' /pytools/bin/ffsubsync

      ffsubsync-script:
        image:
          repository: alpine
          tag: "3.20"
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /temp/scripts && \
            cp /opt/ffsubsync/ffsubsync.sh /temp/scripts/ffsubsync.sh && \
            chmod +x /temp/scripts/ffsubsync.sh
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - name: ffsubsync-scripts
            mountPath: /opt/ffsubsync
            readOnly: true
      
    containers:
      tdarr-node:
        image:
          repository: docker.io/haveagitgat/tdarr_node
          tag: latest
        env:
          TZ: Europe/London
          serverIP: tdarr-server
          serverPort: "8266"
          nodeID: tdarr-node

          PYTHONPATH: /pytools
          PATH: /pytools/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

service:
  web:
    controller: server
    type: ClusterIP
    ports:
      http:
        port: 8265
        protocol: TCP

  server:
    controller: server
    type: ClusterIP
    ports:
      server:
        port: 8266
        protocol: TCP

ingress:
  web:
    enabled: true
    className: traefik-internal
    hosts:
      - host: tdarr.gregpakes.co.uk
        paths:
          - path: /
            service:
              identifier: web
              port: http

persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: tdarr-config
    globalMounts:
      - path: /app/server
      - path: /app/configs

  # GPU passthrough 
  dri:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    hostPathType: Directory

  cache:
    enabled: true
    type: hostPath
    hostPath: /mnt/tdarr-cache
    hostPathType: DirectoryOrCreate
    globalMounts:
      - path: /temp

  media:
    enabled: true
    type: nfs
    server: 172.16.250.191
    path: /var/nfs/shared/Media
    globalMounts:
      - path: /media
  
  pytools:
    enabled: true
    type: emptyDir

  ffsubsync-scripts:
    enabled: true
    type: configMap
    name: tdarr-ffsubsync-scripts

advancedMounts:
  server:
    tdarr:
      - name: dri
        path: /dev/dri
  node:
    tdarr-node:
      - name: dri
        path: /dev/dri
      - name: pytools
        path: /pytools
      - name: ffsubsync-scripts
        path: /opt/ffsubsync
        readOnly: true


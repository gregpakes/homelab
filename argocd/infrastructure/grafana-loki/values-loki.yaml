# Loki (grafana/loki) - Monolithic (single binary) with MinIO (S3) object storage
fullnameOverride: loki

deploymentMode: SingleBinary

singleBinary:
  replicas: 2
  persistence:
    enabled: true
    storageClass: longhorn
    size: 10Gi

# Ensure SimpleScalable components stay disabled in SingleBinary mode
write:
  replicas: 0
read:
  replicas: 0
backend:
  replicas: 0

global:
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: loki-s3-credentials

loki:
  auth_enabled: false
  commonConfig:
    replication_factor: 2
  limits_config:
    # Global retention for all tenants (Go duration format). Adjust as desired.
    retention_period: 720h # 30d
  storage:
    type: s3
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
    s3:
      endpoint: minio.minio.svc.cluster.local:9000
      # MinIO "user" name == access key id. We create a MinIO user named "loki".
      accessKeyId: loki
      secretAccessKey: ${LOKI_S3_SECRET_ACCESS_KEY}
      s3ForcePathStyle: true
      insecure: true
  schemaConfig:
    configs:
      - from: 2024-04-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: index_
          period: 24h
  compactor:
    # Required for retention to actually delete data from object storage.
    working_directory: /var/loki/compactor
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_store: s3

monitoring:
  dashboards:
    enabled: true
  serviceMonitor:
    enabled: true
  rules:
    enabled: true
